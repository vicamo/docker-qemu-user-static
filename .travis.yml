dist: trusty
sudo: required
services:
- docker

env:
  global:
  - CONTAINER_NAME=debian_container
  - CONTAINER_EXEC="docker exec -t debian_container"
  - DOCKER_REPO=qemu-user-static
  - secure: "A4GrDdco2GHCDSfK1IRSohYi9JMRvLBAmToWbz7Jx/PQJKm4aSVbK1V85UgLl/8eRypXYd6qIr4tLrfZtuTyYcf4W+qGau3OnAGp36Sjw5GDGutD0juzqjMIgETUWBCmlKFIikC/FR+tCAZCBYutks4YsVPAJp+Vnk+JvIJPrkJy7qR7EU3+oXY1Bv4qvhl4vQwXTerNhI7CwIgW3FXM1ZP3V0HbNfOX06SBU3L1H4taADTD1qkiPQUXCq6lFsir0PABbkcg10yb7V3DaL6a7uPStbGeN8BXxXe+SYepIgs0x3ZpAYx2U/s430JL9oC/Y4Qm0ohywCkqBAq+vNJjn8uODOhAoQLdmok2+29crgDIg3YXmVeRX8D2JqYndOvpFzji/8ioCJlfSznt3QQGutZ4aG8fIPKtW48LkzaC92ulCTn0XZin3wYSJlcz9LLzrGmG/6Y7kdEXYBHbDfSX5B+kD/beIrJal7soZgCxCAqXEvGQU9vCNXEZWrBrVwx9G1u12etADkXVEuvs8uUV2rQaKhZTR7WKAJV8dTnW1VhfjbM2IwJb6vYKQi1L4JtDoYj5mcNfEAkhc8kOtkNKv1xgRmJE+JwG4QZjRc4qPkdqU6KwFxxFZWUuuI1v71QDslDH3BZjfUebcYuiITWHI+KtPRRWaTGRXAzAefWx2Cw="

branches:
  only:
  - master

before_install:
- |
  sudo docker run --detach --interactive --tty --privileged \
    --name ${CONTAINER_NAME} \
    --volume /var/run/docker.sock:/var/run/docker.sock \
    --volume "${TRAVIS_BUILD_DIR}:${TRAVIS_BUILD_DIR}" \
    --workdir "${TRAVIS_BUILD_DIR}" \
    debian:sid /bin/bash
- ${CONTAINER_EXEC} apt update -qq
- ${CONTAINER_EXEC} apt install --no-install-recommends -y docker.io qemu-user-static

script:
- ${CONTAINER_EXEC} env DOCKER_USER=${DOCKER_USER} DOCKER_REPO=${DOCKER_REPO} "${TRAVIS_BUILD_DIR}/build.sh"
- docker images | grep ^${DOCKER_USER}/${DOCKER_REPO} | awk '{print $1 ":" $2}'

after_success:
- |
  if [ "${TRAVIS_PULL_REQUEST}" == "false" -a "${TRAVIS_BRANCH}" == "master" ]; then
    docker login -u "${DOCKER_USER}" -p "${DOCKER_PASS}";
    for image in $(docker images | grep ^${DOCKER_USER}/${DOCKER_REPO} | awk '{print $1 ":" $2}'); do
      docker push $image;
    done
  fi
